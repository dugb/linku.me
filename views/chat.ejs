<% include ./partials/header %>
<body class = "mobile-shift">

  <header>
    <% include ./partials/navbar %>
    <% include ./partials/slide-out-nav %>
  </header>

  <div class = "alerts">
    <% if(error && error.length > 0){ %>
      <div class="alert--userhome alert--red" role="alert">
        <%= error %>
      </div>
    <% } %>
    <% if(success && success.length > 0){ %>
      <div class="alert--userhome alert--green" role="alert">
        <%= success %>
      </div>
    <% } %>
  </div>

<section class = "messenger">
  <!-- contact list -->
  <div class="contacts-list">
    <h3>Contacts</h3>
    <ul id="contact-list">
      <% currentUser.friends.forEach(function(friends){ %>
      <% if(friends){ %>
      <li class = "contact">
        <span class = "contact-name"><%= friends.friend_name %></span>
        <a class = "btn btn-sm btn-info" href="/user-profile/<%= friends.member_id %>">view</a>
        <button id = "<%= friends.friend_name %>" class="btn btn-sm btn--info chatBtn" type="button" name="button">chat</button>

      </li>
      <% }}) %>
    </ul>
  </div>

  <!-- chatBox -->
  <div id="chatWrap" class="chatBoxWrap">
    <div id = "chatTitle" class="chatTitle">
      Chatting with:  id gets set to chat partners name,

    </div>
    <div id="chat" class="chat">Choose a contact to chat with.</div>
    <form id="send-message">
      <input class = " form-input msgInput "id="message" size="35"></input>
      <input class = "btn msgSendBtn" type="submit"></input>
    </form>
  </div>

</section>



</body>
<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
<script type="text/javascript">
  jQuery(function($){
    const socket = io.connect();
    const $messageForm = $('#send-message');
    const $messageBox = $('#message');
    const $chat = $('#chat');
    const $chatBtn = $('.chatBtn');
    const $chatTitle = $('.chatTitle');

    $chatBtn.on("click", function(){
      const clicked_button = $(this);
      $chatTitle.attr("id", clicked_button.attr("id"))
      $chatTitle.html(clicked_button.attr("id"))
      $chat.html('');
      const data = { from: '<%=currentUser.username%>', to: clicked_button.attr("id")}
      socket.emit('get old msgs', data, function(){

      })

    });


    socket.emit('new user', '<%=currentUser.username%>', function(data){
    if (data){
            console.log("OK!!!");
          } else {
            console.log("NOT OK!!!")
          }
    });

        //submit message event-handler
        $('#send-message').submit(function(e){
          e.preventDefault();
          if(($chatTitle.attr("id")!=='chatTitle')&&($messageBox.val().length > 0)){
            console.log("true");
            console.log("submit: ", $messageBox.val());
            const msgData = {
              body: $messageBox.val(),
              author: '<%=currentUser.username%>',
              to: $chatTitle.attr("id")
            }
            socket.emit('send message', msgData, function(data){
              $chat.append('<span class="error">' + data + "</span><br/>");

            });
            $messageBox.val('');
          } else {
            console.log("false");
          }
        });

        socket.on('new message', function(data){
          displayMsg(data)
        });

        socket.on('load old msgs', function(docs){
          for( i=docs.length-1; i>=0; i--){
            console.log("docs: ", docs[i]);
            displayOldMsg(docs[i])
          }
        });

        socket.on('whisper', function(data){
          if((data.nick===$chatTitle.attr("id"))||(data.nick==='<%=currentUser.username%>')){
            if(data.nick==='<%=currentUser.username%>'){
              $chat.append('<span class="msg msg-from"><b>' + data.nick +': </b>'+ data.msg + "</span><br/>");
            } else {
              $chat.append('<span class="msg msg-to"><b>' + data.nick +': </b>'+ data.msg + "</span><br/>");
            }

          }
        });

      function displayMsg(data){
        console.log(data);
        console.log("msg rcvd to client: ", data.msg );
        console.log("from: ", data.nick );
        if (data.nick==='<%=currentUser.username%>'){
          $chat.append('<span class="msg msg-from"><b>' + data.nick +': </b>'+ data.msg + "</span><br/>");
        } else {
          $chat.append('<span class="msg msg-to"><b>' + data.nick +': </b>'+ data.msg + "</span><br/>");
        }
      };

      function displayOldMsg(data){
        if (data.author==='<%=currentUser.username%>'){
          $chat.append('<span class="msg msg-from"><b>' + data.author +': </b>'+ data.body + "</span><br/>");
        } else {
          $chat.append('<span class="msg msg-to"><b>' + data.author +': </b>'+ data.body + "</span><br/>");
        }
      };
});
</script>

</html>
